<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenPaint</title>
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/tailwind.build.css" />
    <style>
      /* Custom styles for image list and tag system */
      .image-container {
        border-left: 2px solid transparent;
        transition: all 0.2s ease;
      }

      .image-container:hover {
        border-left-color: #3b82f6;
        background-color: #f8fafc;
      }

      .image-container[aria-selected='true'] {
        border-left-color: #3b82f6;
        background-color: #eff6ff;
      }

      .tag-badge {
        display: inline-block;
        background-color: #e0e7ff;
        color: #3730a3;
        font-size: 10px;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 6px;
        line-height: 1;
      }

      .no-tags {
        font-size: 10px;
        color: #9ca3af;
        font-style: italic;
      }

      .image-label:hover {
        background-color: #f1f5f9 !important;
      }

      /* Modern slider styling (align with original OpenPaint) */
      .slider {
        --accent: #3b82f6;
        --p: 0;
        /* 0..1 progress (set by JS) */
        --filled: 30%;
        /* legacy percent for compatibility */
        --track-h: 6px;
        /* track height */
        --thumb: 16px;
        /* thumb diameter (px) */
        /* align fill end exactly under thumb center across browsers */
        --pos: calc((var(--p) * (100% - var(--thumb))) + (var(--thumb) / 2));
        -webkit-appearance: none;
        appearance: none;
        outline: none;
        border-radius: 9999px;
        height: var(--track-h);
        background: transparent;
        /* let track draw the background */
      }

      /* WebKit/Blink track + thumb */
      .slider::-webkit-slider-runnable-track {
        height: var(--track-h);
        border-radius: 9999px;
        background: linear-gradient(
          to right,
          var(--accent) 0,
          var(--accent) var(--pos),
          #e5e7eb var(--pos),
          #e5e7eb 100%
        );
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: var(--thumb);
        height: var(--thumb);
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        /* keep a subtle depth but pull the blue glow inside the thumb */
        box-shadow:
          inset 0 0 0 3px rgba(59, 130, 246, 0.45),
          0 1px 2px rgba(0, 0, 0, 0.07);
        transition: all 0.2s ease;
        /* center the thumb on a thin track */
        margin-top: calc((var(--track-h) - var(--thumb)) / 2);
      }

      .slider::-webkit-slider-thumb:hover {
        transform: scale(1.08);
        box-shadow:
          inset 0 0 0 4px rgba(59, 130, 246, 0.55),
          0 2px 3px rgba(0, 0, 0, 0.08);
      }

      /* Firefox track + thumb + progress */
      .slider::-moz-range-track {
        height: var(--track-h);
        border-radius: 9999px;
        background: #e5e7eb;
      }

      .slider::-moz-range-progress {
        height: var(--track-h);
        border-radius: 9999px;
        background: var(--accent);
      }

      .slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        border: none;
        box-shadow:
          inset 0 0 0 3px rgba(59, 130, 246, 0.45),
          0 1px 2px rgba(0, 0, 0, 0.07);
        transition: all 0.2s ease;
      }

      .slider::-moz-range-thumb:hover {
        transform: scale(1.08);
        box-shadow:
          inset 0 0 0 4px rgba(59, 130, 246, 0.55),
          0 2px 3px rgba(0, 0, 0, 0.08);
      }

      /* Match original OpenPaint slider width */
      #brushSize {
        width: 120px;
        margin: 0;
      }

      /* Remove native focus outline while keeping custom inset ring */
      .slider {
        -webkit-tap-highlight-color: transparent;
      }

      .slider:focus,
      .slider:focus-visible {
        outline: none !important;
        box-shadow: none;
      }

      .slider::-moz-focus-outer {
        border: 0;
      }

      /* Shake animation for error feedback */
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-3px); }
        75% { transform: translateX(3px); }
      }

      /* Icon transition styles for copy button */
      .copy-icon-container svg {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
    </style>

    <!-- Loading optimization and debug gate -->
    <style>
      /* Hide UI until initialization completes to prevent flash */
      .app-loading body {
        visibility: hidden !important;
      }

      /* Hide toolbar completely until ready - prevents any flicker */
      #topToolbar:not(.toolbar-ready) {
        display: none !important;
        /* Completely remove from layout */
      }

      /* Show toolbar only when ready */
      #topToolbar.toolbar-ready {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        transition: none !important;
        /* Disable transitions during initialization to prevent flicker */
      }

      /* After initialization completes, enable smooth transitions */
      #topToolbar.toolbar-ready.toolbar-stable {
        transition:
          opacity 0.2s ease,
          visibility 0s;
      }

      /* Panels load immediately - no hiding during app-loading */
      /* They start expanded and visible by default */

      /* Ensure stable toolbar layout from the start */
      #topToolbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-bottom: 1px solid rgb(226, 232, 240);
        height: 48px;
      }

      .toolbar-wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 48px;
      }

      #tbLeft,
      #tbCenter,
      #tbRight {
        position: relative;
        display: flex;
        align-items: center;
        flex-shrink: 0;
        /* Prevent shrinking that causes layout shifts */
        min-width: 0;
        /* Allow flex items to shrink below content size if needed */
      }

      /* Stabilize button widths to prevent jumping */
      #tbLeft .tbtn,
      #tbRight .tbtn {
        min-width: fit-content;
        /* Ensure buttons don't collapse */
        white-space: nowrap;
        /* Prevent text wrapping */
      }

      /* Ensure label spans don't cause width changes */
      .label-long,
      .label-short {
        display: inline-block;
        /* Use inline-block for more stable layout */
        white-space: nowrap;
      }

      /* Mobile: Make toolbar horizontally scrollable by default */
      @media (max-width: 768px) {
        .toolbar-wrap {
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: thin;
          scrollbar-color: rgba(148, 163, 184, 0.5) transparent;
          justify-content: flex-start;
          gap: 12px;
          padding: 0 8px;
          position: relative;
          cursor: pointer;
        }

        .toolbar-wrap::-webkit-scrollbar {
          height: 4px;
        }

        .toolbar-wrap::-webkit-scrollbar-track {
          background: transparent;
        }

        .toolbar-wrap::-webkit-scrollbar-thumb {
          background: rgba(148, 163, 184, 0.5);
          border-radius: 2px;
        }

        .toolbar-wrap::-webkit-scrollbar-thumb:hover {
          background: rgba(148, 163, 184, 0.7);
        }

        /* Prevent toolbar groups from wrapping in scrollable mode */
        .toolbar-wrap:not(.expanded) #tbLeft,
        .toolbar-wrap:not(.expanded) #tbCenter,
        .toolbar-wrap:not(.expanded) #tbRight {
          flex-shrink: 0;
          flex-wrap: nowrap;
        }

        /* Ensure buttons don't shrink in scrollable mode */
        .toolbar-wrap:not(.expanded) .tbtn,
        .toolbar-wrap:not(.expanded) .tinput,
        .toolbar-wrap:not(.expanded) .color-swatches,
        .toolbar-wrap:not(.expanded) .slider {
          flex-shrink: 0;
        }

        /* Expanded/wrapped mode - up to 5 rows */
        .toolbar-wrap.expanded {
          overflow-x: visible;
          overflow-y: visible;
          flex-wrap: wrap;
          align-content: flex-start;
          height: auto;
          max-height: calc(5 * (32px + 6px));
          /* 5 rows: button height + gap */
          padding: 8px;
          gap: 6px;
        }

        /* In expanded mode, flatten groups so items wrap together */
        .toolbar-wrap.expanded #tbLeft,
        .toolbar-wrap.expanded #tbCenter,
        .toolbar-wrap.expanded #tbRight {
          flex-wrap: wrap;
          flex-shrink: 1;
          gap: 6px;
          display: contents;
          /* Flatten structure so items wrap together */
        }

        /* Ensure items maintain spacing in expanded mode */
        .toolbar-wrap.expanded .group-gap > * {
          margin-right: 6px;
          margin-bottom: 0;
        }

        .toolbar-wrap.expanded .tbtn,
        .toolbar-wrap.expanded .tinput,
        .toolbar-wrap.expanded .color-swatches,
        .toolbar-wrap.expanded .slider {
          flex-shrink: 0;
        }

        /* Visual indicator at bottom for tap area */
        .toolbar-wrap::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          height: 8px;
          background: linear-gradient(to top, rgba(148, 163, 184, 0.1), transparent);
          pointer-events: none;
          opacity: 0.5;
          transition: opacity 0.2s;
        }

        .toolbar-wrap.expanded::after {
          opacity: 0;
        }

        /* Blue glow animation when expandable */
        @keyframes blueGlow {
          0%,
          100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
          }

          50% {
            box-shadow: 0 0 12px 4px rgba(59, 130, 246, 0.6);
          }
        }

        .toolbar-wrap.expandable {
          animation: blueGlow 0.5s ease-in-out;
          animation-fill-mode: none;
          /* Don't persist animation state */
        }

        .toolbar-wrap.tapped {
          animation: blueGlow 1s ease-in-out;
          animation-fill-mode: none;
          /* Don't persist animation state */
        }

        /* Glow on hover only if expandable (when scrollable) */
        .toolbar-wrap:not(.expanded)[data-scrollable='true']:hover:not(.no-glow) {
          box-shadow: 0 0 12px 4px rgba(59, 130, 246, 0.6);
          transition: box-shadow 0.2s ease-in-out;
        }

        /* Ensure no glow when not hovering (even if scrollable) */
        .toolbar-wrap:not(.expanded)[data-scrollable='true']:not(:hover):not(.expandable):not(
            .tapped
          ) {
          box-shadow: none !important;
        }

        /* Force no glow when no-glow class is present */
        .toolbar-wrap.no-glow {
          box-shadow: none !important;
        }
      }

      .group-gap > * {
        margin-right: 6px;
      }

      .group-gap > *:last-child {
        margin-right: 0;
      }

      /* Ensure all toolbar buttons have consistent sizing */
      .tbtn {
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: #fff;
        font-size: 12px;
        line-height: 1;
        transition: all 0.15s ease;
        white-space: nowrap;
      }

      .tinput {
        height: 32px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: #fff;
        font-size: 12px;
        line-height: 1;
        transition: all 0.15s ease;
      }

      .icon-btn {
        width: 32px;
        justify-content: center;
        padding: 0;
      }

      /* Rotate controls: big swing hover state */
      #rotateLeftCtrl,
      #rotateRightCtrl {
        position: relative;
        overflow: hidden;
        transform-origin: 50% 60%;
        transition:
          transform 0.18s ease,
          box-shadow 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease,
          color 0.18s ease;
      }

      #rotateLeftCtrl::after,
      #rotateRightCtrl::after {
        content: '';
        position: absolute;
        inset: -40%;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(59, 130, 246, 0.25),
          rgba(14, 116, 144, 0.0) 60%
        );
        opacity: 0;
        transition: opacity 0.18s ease;
        pointer-events: none;
      }

      #rotateLeftCtrl:hover,
      #rotateRightCtrl:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-color: rgba(59, 130, 246, 0.6);
        box-shadow:
          0 10px 24px rgba(15, 23, 42, 0.18),
          0 0 0 2px rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }

      #rotateLeftCtrl:hover {
        transform: rotate(-12deg) scale(1.08);
      }

      #rotateRightCtrl:hover {
        transform: rotate(12deg) scale(1.08);
      }

      #rotateLeftCtrl:hover::after,
      #rotateRightCtrl:hover::after {
        opacity: 1;
      }

      #rotateLeftCtrl:active,
      #rotateRightCtrl:active {
        transform: scale(0.96);
        box-shadow:
          0 6px 14px rgba(15, 23, 42, 0.12),
          0 0 0 2px rgba(59, 130, 246, 0.12);
      }

      #rotateLeftCtrl:focus-visible,
      #rotateRightCtrl:focus-visible {
        outline: 2px solid rgba(59, 130, 246, 0.65);
        outline-offset: 2px;
      }

      .rotate-fine-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
      }

      .rotate-fine-panel {
        position: absolute;
        bottom: calc(100% + 4px);
        left: 50%;
        transform: translate(-50%, 8px);
        opacity: 0;
        pointer-events: none;
        background: rgba(255, 255, 255, 0.98);
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
        border-radius: 14px;
        padding: 8px 10px;
        min-width: 220px;
        transition: opacity 0.16s ease, transform 0.16s ease;
      }

      .rotate-fine-wrap:hover .rotate-fine-panel,
      .rotate-fine-wrap:focus-within .rotate-fine-panel,
      .rotate-fine-panel:hover {
        opacity: 1;
        pointer-events: auto;
        transform: translate(-50%, 0);
      }

      .rotate-fine-wrap::after {
        content: '';
        position: absolute;
        left: -6px;
        right: -6px;
        top: -22px;
        height: 26px;
      }

      .rotate-fine-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .rotate-fine-label {
        font-size: 11px;
        font-weight: 600;
        color: #0f172a;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      #rotateFineSlider {
        appearance: none;
        height: 6px;
        border-radius: 999px;
        background: linear-gradient(90deg, #0ea5e9 0%, #6366f1 100%);
        outline: none;
        flex: 1;
        cursor: pointer;
      }

      #rotateFineSlider::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #0f172a;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
        border: 2px solid #fff;
        cursor: pointer;
      }

      #rotateFineSlider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #0f172a;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.25);
        border: 2px solid #fff;
        cursor: pointer;
      }

      #fineRotateGrid {
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0;
        background-image:
          linear-gradient(rgba(148, 163, 184, 0.18) 1px, transparent 1px),
          linear-gradient(90deg, rgba(148, 163, 184, 0.18) 1px, transparent 1px);
        background-size: 40px 40px;
        transition: opacity 0.18s ease;
        z-index: 12;
      }

      body.fine-rotate-active #fineRotateGrid,
      body.capture-unlocked #fineRotateGrid {
        opacity: 1;
      }

      .rotate-fine-value {
        font-variant-numeric: tabular-nums;
        font-size: 12px;
        font-weight: 600;
        color: #0f172a;
        min-width: 36px;
        text-align: right;
      }


      /* Specific button styles to prevent layout shifts */
      #paste {
        padding: 8px 16px;
        background: rgb(59, 130, 246);
        color: white;
        font-weight: 600;
        border-radius: 12px;
        border: none;
      }

      #clear {
        padding: 8px 16px;
        background: rgb(239, 68, 68);
        color: white;
        font-weight: 600;
        border-radius: 12px;
        border: none;
      }

      #drawingModeToggle {
        padding: 8px 16px;
        background: white;
        color: rgb(34, 197, 94);
        font-weight: 600;
        border-radius: 12px;
        border: 2px solid rgb(34, 197, 94);
      }

      .shape-toggle {
        position: relative;
        display: inline-flex;
        align-items: center;
      }

      .shape-toggle .shape-icon {
        margin-left: 6px;
        font-size: 14px;
      }

      .shape-toggle.shape-disabled {
        opacity: 0.7;
      }

      .shape-toggle.shape-disabled .shape-menu {
        pointer-events: none;
      }

      .shape-toggle.shape-disabled #shapeModeToggle {
        pointer-events: auto;
        cursor: pointer;
      }

      .shape-toggle .shape-menu {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 6px;
        display: none;
        flex-direction: column;
        gap: 4px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
        z-index: 60;
        min-width: 120px;
      }

      .shape-toggle.shape-active.shape-open .shape-menu,
      .shape-toggle.shape-active:focus-within .shape-menu,
      .text-mode-toggle.shape-open .shape-menu {
        display: flex;
      }

      .text-mode-toggle .tbtn {
        border-color: #cbd5e1;
        color: #475569;
        background: #f8fafc;
      }

      .text-mode-toggle.shape-active .tbtn {
        border-color: #3b82f6;
        color: #1d4ed8;
        background: #eff6ff;
      }

      .text-mode-toggle .shape-icon {
        font-size: 14px;
      }

      .text-mode-toggle.text-size-small .shape-icon {
        font-size: 10px;
      }

      .text-mode-toggle.text-size-medium .shape-icon {
        font-size: 12px;
      }

      .text-mode-toggle.text-size-large .shape-icon {
        font-size: 14px;
      }

      .shape-toggle .shape-menu button {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        padding: 6px 8px;
        border: 1px solid transparent;
        background: #fff;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        outline: none;
        color: #374151;
        transition: background 0.15s, border-color 0.15s;
      }

      .shape-toggle .shape-menu button:hover:not(.active) {
        background: #f3f4f6;
        border-color: #d1d5db;
      }

      .shape-toggle .shape-menu button:focus-visible {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }

      .shape-toggle .shape-menu button.active {
        border-color: #3b82f6;
        background: #eff6ff;
        color: #1d4ed8;
        font-weight: 500;
      }

      .shape-toggle .shape-menu button.active::before {
        content: 'âœ“ ';
        font-weight: bold;
      }

      #projectName {
        width: 140px;
        padding: 8px 12px;
        border: 1px solid rgb(209, 213, 219);
        border-radius: 12px;
        background: white;
        font-size: 14px;
      }

      #loadProject {
        padding: 8px 16px;
        background: white;
        color: rgb(51, 65, 85);
        font-weight: 600;
        border-radius: 12px;
        border: 1px solid rgb(209, 213, 219);
        font-size: 12px;
      }

      #saveProjectTop {
        padding: 8px 16px;
        background: rgb(59, 130, 246);
        color: white;
        font-weight: 700;
        border-radius: 12px;
        border: 1px solid rgb(37, 99, 235);
        font-size: 14px;
      }

      #updateShareBtn {
        padding: 6px 12px;
        background: rgb(14, 165, 233);
        color: white;
        font-weight: 600;
        border-radius: 12px;
        border: 1px solid rgb(2, 132, 199);
        margin-left: 8px;
      }

      #unitToggleBtn {
        padding: 6px 12px;
        background: white;
        color: rgb(51, 65, 85);
        font-weight: 600;
        border-radius: 12px;
        border: 1px solid rgb(209, 213, 219);
      }

      /* Color swatches */
      .color-swatches {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .text-bg-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 600;
        color: #334155;
        background: #ffffff;
        border: 1px solid #cbd5f5;
        border-radius: 999px;
        padding: 4px 8px;
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      }

      .text-bg-toggle-input {
        accent-color: #3b82f6;
      }

      .color-swatches button {
        width: 20px;
        height: 20px;
        border-radius: 9999px;
        border: 2px solid white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        margin: 0;
        padding: 0;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .color-swatches button:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
      }

      /* Responsive text labels */
      .label-long {
        display: inline-block;
        white-space: nowrap;
      }

      .label-short {
        display: none;
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        .label-long {
          display: none;
        }

        .label-short {
          display: inline-block;
        }

        /* Constrain panel widths on mobile to trigger scrolling */
        #toolsPanel {
          max-width: calc(100vw - 2rem);
          left: 1rem !important;
        }

        #canvasControls {
          max-width: calc(100vw - 2rem);
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
        }

        /* Enable horizontal scrolling for panel content on mobile */
        #toolsPanelContent,
        #canvasControlsContent {
          overflow-x: auto !important;
          overflow-y: visible !important;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: thin;
          flex-wrap: nowrap !important;
        }

        /* Ensure buttons don't shrink */
        #canvasControlsContent > * {
          flex-shrink: 0;
        }

        /* Prevent wrapping on flex rows inside panels */
        #toolsPanelContent .flex.items-center,
        #toolsPanelContent > div,
        #canvasControlsContent.flex {
          flex-wrap: nowrap !important;
        }

        /* Ensure buttons don't shrink */
        #toolsPanelContent button,
        #canvasControlsContent button,
        #canvasControlsContent select {
          flex-shrink: 0;
        }

        /* Hide scrollbars for cleaner look */
        #toolsPanelContent::-webkit-scrollbar,
        #canvasControlsContent::-webkit-scrollbar {
          height: 4px;
        }

        #toolsPanelContent::-webkit-scrollbar-thumb,
        #canvasControlsContent::-webkit-scrollbar-thumb {
          background: rgba(0, 0, 0, 0.2);
          border-radius: 2px;
        }
      }

      body {
        margin: 0;
        padding: 0;
        font-weight: 500;
      }

      #lockPopup.show {
        display: flex !important;
        animation: fadeInOut 1.5s ease-in-out;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }

        20% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }

        80% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }

        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
      }

      /* Lock button states */
      #captureLockButton .locked-icon {
        display: none;
      }

      #captureLockButton .unlocked-icon {
        display: block;
      }

      #captureLockButton.locked .locked-icon {
        display: block;
      }

      #captureLockButton.locked .unlocked-icon {
        display: none;
      }

      /* Hide resize handles when locked */
      .capture-frame.locked .resize-handles {
        display: none;
      }

      /* Drag over canvas effects */
      #canvas.drag-over {
        background: rgba(76, 175, 80, 0.05);
      }

      /* Panel minimization styles - consolidated from multiple rules */
      .floating-panel.minimized {
        width: auto !important;
        height: auto !important;
        max-height: none !important;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      }

      .floating-panel.minimized .cursor-move {
        border-bottom: none;
      }

      /* When elementsBody is hidden, ensure panel shrinks to header only */
      #strokePanel:has(#elementsBody.hidden) {
        height: auto !important;
      }

      #imagePanel:has(#imagePanelContent.hidden) {
        height: auto !important;
        min-height: 140px !important;
        /* Header + name box + some padding */
      }

      /* Ensure entire panels load simultaneously - no sequential loading */
      #imagePanel,
      #strokePanel {
        display: flex;
        flex-direction: column !important;
      }

      /* Ensure all panel parts load together (no header-first loading) */
      #imagePanelHeader,
      #imagePanel > .px-3.bg-white.border-b.border-slate-200.py-2,
      #imagePanelContent,
      #elementsHeader,
      #elementsBody {
        visibility: visible;
        opacity: 1;
      }

      /* Disable transitions on initial load to prevent sequential appearance */
      #imagePanel:not([data-loaded]),
      #strokePanel:not([data-loaded]) {
        transition: none !important;
      }

      #imagePanelContent:not([data-loaded]),
      #elementsBody:not([data-loaded]) {
        transition: none !important;
      }

      /* Ensure image name header is always visible and not squished */
      /* Ensure image name header is visible only when not collapsed */
      #imagePanel:not(.collapsed) > .image-name-container {
        flex-shrink: 0 !important;
        min-height: 60px !important;
        position: relative !important;
        z-index: 10 !important;
        display: block !important;
      }

      /* Explicitly hide when collapsed */
      #imagePanel.collapsed > .image-name-container {
        display: none !important;
      }

      /* Ensure the image name input is always visible */
      #currentImageNameBox {
        display: block !important;
        width: 100% !important;
      }

      /* On mobile, allow JavaScript to control visibility */
      @media (max-width: 768px) {
        #imagePanel[style*='display: none'] {
          display: none !important;
        }
      }

      /* Ensure content area doesn't affect header visibility */
      #imagePanelContent {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        overflow: hidden !important;
      }

      /* Panel toggle icons for mobile */
      .panel-toggle-icon {
        position: fixed;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: none;
        /* Hidden by default, shown via JS on mobile */
        align-items: center;
        justify-content: center;
        font-size: 28px;
        cursor: pointer;
        z-index: 10100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition:
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
        pointer-events: auto;
        opacity: 0;
        /* Start hidden to prevent pop-in */
      }

      /* Smooth fade-in when shown */
      .panel-toggle-icon[style*='display: flex'] {
        opacity: 1;
        transition:
          opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .panel-toggle-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }

      .panel-toggle-icon:active {
        transform: scale(0.95);
      }

      #strokePanelIcon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      #imagePanelIcon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      /* Position when minimized */
      #strokePanelIcon.minimized {
        left: 1rem;
        bottom: 5rem;
        top: auto;
      }

      #imagePanelIcon.minimized {
        right: 1rem;
        bottom: 5rem;
        top: auto;
      }

      /* Mobile: Position canvasControls above the panel toggle icons */
      @media (max-width: 768px) {
        #canvasControls {
          bottom: calc(5rem + 56px + 1rem) !important;
          /* Above icons (5rem) + icon height (56px) + spacing (1rem) */
          left: 50% !important;
          transform: translateX(-50%) !important;
        }
      }

      /* Position when expanded */
      #strokePanelIcon.expanded {
        left: 0.5rem;
        top: 0.5rem;
        bottom: auto;
      }

      #imagePanelIcon.expanded {
        right: 0.5rem;
        top: 0.5rem;
        left: auto;
        bottom: auto;
      }

      /* Minimal Numeric Pill Strip Styling */
      #mini-stepper {
        scrollbar-width: none;
        -ms-overflow-style: none;
        min-height: 60px;
        position: relative;
      }

      #mini-stepper-indicator {
        position: absolute;
        top: 50%;
        left: 0;
        width: 32px;
        height: 32px;
        border-radius: 9999px;
        background: #0f172a;
        transform: translate3d(0, -50%, 0);
        transition: transform 120ms linear;
        will-change: transform;
        pointer-events: none;
        z-index: 5;
      }

      #mini-stepper .step {
        position: relative;
        z-index: 10;
      }

      #mini-stepper::-webkit-scrollbar {
        display: none;
      }

      /* Navigation container styling - Always visible, independent of panel state */
      #navigation-container {
        background: white;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 40 !important;
        width: 100% !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Ensure navigation container stays visible even when imagePanel is minimized */
      #imagePanel.minimized ~ #navigation-container,
      #imagePanel:has(#imagePanelContent.hidden) ~ #navigation-container,
      body:has(#imagePanel.minimized) #navigation-container,
      body:has(#imagePanel:has(#imagePanelContent.hidden)) #navigation-container {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Ensure the navigation strip is always visible */
      nav[aria-label='Image quick nav'] {
        display: block !important;
        visibility: visible !important;
      }

      /* Ensure navigation container is never affected by panel collapse */
      #navigation-container,
      #navigation-container * {
        pointer-events: auto !important;
        /* outline removed - was debug styling */
      }

      #mini-stepper .step[aria-current='true'] {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        z-index: 20;
      }

      /* Ensure pills are always clickable */
      #mini-stepper button {
        pointer-events: auto !important;
        user-select: none;
        cursor: pointer;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      /* Ensure stepper is always visible - independent of panel state */
      #mini-stepper {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }

      /* Ensure stepper stays visible when imagePanel is minimized */
      #imagePanel.minimized ~ #navigation-container #mini-stepper,
      #imagePanel:has(#imagePanelContent.hidden) ~ #navigation-container #mini-stepper,
      body:has(#imagePanel.minimized) #mini-stepper,
      body:has(#imagePanel:has(#imagePanelContent.hidden)) #mini-stepper {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Ensure frame capture container allows scrolling */
      #frame-capture {
        scroll-behavior: smooth;
      }

      /* Section styling for better visual separation */
      #frame-capture section {
        scroll-margin-top: 2rem;
      }

      /* Responsive adjustments for mobile */
      @media (max-width: 768px) {
        #mini-stepper .step {
          min-width: 2.5rem;
          min-height: 2.5rem;
          font-size: 0.875rem;
        }

        #mini-stepper {
          gap: 0.75rem;
          padding-left: 1rem;
          padding-right: 1rem;
        }
      }

      /* Smooth transitions for all panel content */
      .floating-panel [id$='Content'],
      .floating-panel [id$='Controls'],
      #elementsBody {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .floating-panel [id$='Content'].hidden,
      .floating-panel [id$='Controls'].hidden,
      #elementsBody.hidden {
        max-height: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        opacity: 0;
      }

      /* Enhanced button hover effects - with stacking context isolation */
      .floating-panel button[id^='toggle'] svg {
        isolation: isolate;
      }

      .floating-panel button[id^='toggle']:hover svg {
        transform: scale(1.1);
        isolation: isolate;
      }

      /* Make canvasControls scrollable on all screen sizes */

      #canvasControls::-webkit-scrollbar {
        height: 4px;
      }

      #canvasControls::-webkit-scrollbar-track {
        background: transparent;
      }

      #canvasControls::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.5);
        border-radius: 2px;
      }

      #canvasControls::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.7);
      }

      /* Allow overflow for canvas controls to show hover menu and enable scrolling */
      #canvasControlsContent {
        /* Overflow handled by media query for mobile */
        flex-wrap: nowrap !important;
        min-width: max-content;
        /* Override generic panel overflow to allow dropdowns */
        overflow: visible !important;
      }

      #canvasControlsContent::-webkit-scrollbar {
        height: 4px;
      }

      #canvasControlsContent::-webkit-scrollbar-track {
        background: transparent;
      }

      #canvasControlsContent::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.5);
        border-radius: 2px;
      }

      #canvasControlsContent::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.7);
      }

      /* Ensure buttons and controls don't shrink */
      #canvasControlsContent > * {
        flex-shrink: 0;
      }

      /* Note: overflow-x: auto takes precedence for horizontal scrolling */
      /* Vertical overflow remains visible for dropdown menus */

      /* STEP 2: CSS variants - Use data-toolbar-mode to control label display */
      /* 
         * Toolbar Label Sizing System:
         * 
         * This system uses a global data-toolbar-mode attribute on <html> to control
         * toolbar label display, preventing flicker and pop-in during page load.
         * 
         * How it works:
         * 1. Early script (in <head>) sets data-toolbar-mode='full' or 'compact' based on viewport width
         * 2. CSS reads this attribute to show/hide .label-long and .label-short spans
         * 3. JS fallback recalculates after fonts load and on window resize
         * 4. ResizeObserver is disabled for toolbar containers to prevent flicker loops
         * 
         * Benefits:
         * - No DOM rewrites (only attribute changes)
         * - CSS handles display immediately (no JS delay)
         * - Prevents flicker by determining size before toolbar becomes visible
         * - Works on both desktop and mobile
         */
      /* Base state: show long labels, hide short labels */
      .label-long {
        display: inline-block;
        white-space: nowrap;
      }

      .label-short {
        display: none;
        white-space: nowrap;
      }

      /* When toolbar mode is 'compact', show short labels instead */
      [data-toolbar-mode='compact'] .smart-label-scope .label-long,
      [data-toolbar-mode='compact'] .toolbar-wrap .label-long {
        display: none !important;
      }

      [data-toolbar-mode='compact'] .smart-label-scope .label-short,
      [data-toolbar-mode='compact'] .toolbar-wrap .label-short {
        display: inline-block !important;
      }

      /* When toolbar mode is 'full', ensure full labels show (override any compact classes) */
      [data-toolbar-mode='full'] .smart-label-scope .label-long,
      [data-toolbar-mode='full'] .toolbar-wrap .label-long,
      [data-toolbar-mode='full'] .smart-label-scope.compact .label-long,
      [data-toolbar-mode='full'] .toolbar-wrap.compact .label-long {
        display: inline-block !important;
      }

      [data-toolbar-mode='full'] .smart-label-scope .label-short,
      [data-toolbar-mode='full'] .toolbar-wrap .label-short,
      [data-toolbar-mode='full'] .smart-label-scope.compact .label-short,
      [data-toolbar-mode='full'] .toolbar-wrap.compact .label-short {
        display: none !important;
      }

      /* Legacy support: Keep old compact class behavior for non-toolbar elements */
      .smart-label-scope.compact:not(.toolbar-wrap):not([id^='tb']) .label-long {
        display: none;
      }

      .smart-label-scope.compact:not(.toolbar-wrap):not([id^='tb']) .label-short {
        display: inline-block;
      }

      /* Button width reservations to prevent layout shift */
      #paste {
        min-width: 60px;
        /* "Upload" short label width */
        max-width: 140px;
        /* "Upload Images" long label width */
      }

      #saveProjectTop {
        min-width: 50px;
        /* "Save" short label width */
        max-width: 120px;
        /* "Save Project" long label width */
      }

      #loadProject {
        min-width: 50px;
        /* "Load" short label width */
        max-width: 120px;
        /* "Load Project" long label width */
      }

      #drawingModeToggle {
        min-width: 70px;
        /* "Straight" short label width */
        max-width: 120px;
        /* "Straight Line" long label width */
      }

      #textModeToggle {
        min-width: 40px;
        /* "Text" short label width */
        max-width: 60px;
        /* "Text" long label width */
      }

      #projectName {
        min-width: 100px;
        max-width: 200px;
      }

      /* Text mode active state */
      .text-mode-active {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #2563eb !important;
      }

      /* Removed duplicate - merged into main .floating-panel.minimized rule */

      /* Enhanced arrow button styling */
      #startArrow.active,
      #endArrow.active,
      #arrowStartBtn.active,
      #arrowEndBtn.active {
        background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
        color: white !important;
        transform: scale(1.05) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
        border: 2px solid #1d4ed8 !important;
        font-weight: 600 !important;
      }

      #startArrow.active:hover,
      #endArrow.active:hover,
      #arrowStartBtn.active:hover,
      #arrowEndBtn.active:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
        transform: scale(1.08) !important;
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5) !important;
      }

      /* Arrow button transitions */
      #startArrow,
      #endArrow,
      #arrowStartBtn,
      #arrowEndBtn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      }

      .floating-panel:not(.minimized) {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      /* Removed duplicate - merged with other .dragging rule below */

      /* Keep Elements header always visible; body uses remaining space */
      #strokePanel {
        display: flex;
        flex-direction: column;
        /* Let the panel grow to near full viewport height while preserving drag behavior */
        max-height: calc(100vh - 24px) !important;
      }

      #elementsHeader {
        flex: 0 0 auto;
      }

      #elementsBody {
        flex: 1 1 auto;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* removed elementsResizeHandle */
      #elementsControls {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
      }

      #strokeVisibilityControls {
        flex: 1 1 auto;
        min-height: 0;
        /* allows flex child to shrink for scrolling in Firefox */
        overflow-y: auto !important;
        /* Remove transition that causes flickering */
        transition: none !important;
      }

      /* Header dragging styles */
      .cursor-move:active {
        cursor: grabbing !important;
      }

      /* Fix stroke visibility item layout - with stacking context isolation */
      .stroke-visibility-item {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        padding: 8px !important;
        margin-bottom: 4px !important;
        background: white !important;
        border-radius: 6px !important;
        border: 1px solid #e5e7eb !important;
        transition: all 0.2s ease !important;
        isolation: isolate;
        transform: translateZ(0);
      }

      /* Ensure the strokes list flows vertically and doesn't overlap */
      #strokesList {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .stroke-actions-panel {
        display: block;
        margin: 6px 0;
      }

      .stroke-actions-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      /* Make the strokes area adjustable but constrained so new items never overlap headers */
      #strokeVisibilityControls {
        flex: 1 1 0;
        min-height: 0;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        box-sizing: border-box;
        position: relative;
        transition: none !important;
      }

      #strokeVisibilityControls hr {
        margin: 6px 0;
      }

      .stroke-visibility-item:hover {
        background-color: #f9fafb !important;
        border-color: #d1d5db !important;
      }

      .stroke-label-container {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        flex: 1 !important;
      }

      .stroke-name {
        font-weight: 600 !important;
        font-size: 14px !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        border: 1px solid currentColor !important;
        min-width: auto !important;
      }

      .stroke-label-toggle-btn {
        background: none !important;
        border: none !important;
        cursor: pointer !important;
        font-size: 16px !important;
        line-height: 1 !important;
        padding: 2px !important;
        opacity: 0.8 !important;
      }

      .stroke-label-toggle-btn:hover {
        opacity: 1 !important;
      }

      .stroke-measurement {
        font-size: 13px !important;
        color: #6b7280 !important;
        font-weight: 500 !important;
        user-select: text !important;
        cursor: pointer !important;
        padding: 1px 4px !important;
        border-radius: 3px !important;
        transition: background-color 0.2s !important;
        min-width: 30px !important;
        display: inline-block !important;
        text-align: center !important;
        min-height: 20px !important;
        vertical-align: middle !important;
      }

      .stroke-measurement.empty-measurement {
        border: 1px solid #d1d5db !important;
        /* Grey outline */
      }

      .stroke-measurement:focus,
      .stroke-measurement[contenteditable='true'] {
        outline: none !important;
        border: 1px solid #3b82f6 !important;
        /* Blue outline */
        box-shadow: 0 0 0 1px #3b82f6 !important;
        background-color: white !important;
      }

      .stroke-measurement:hover {
        background-color: #f3f4f6 !important;
        color: #374151 !important;
      }

      .stroke-delete-btn {
        background: none !important;
        border: none !important;
        color: #ef4444 !important;
        cursor: pointer !important;
        font-size: 16px !important;
        font-weight: bold !important;
        padding: 2px 6px !important;
        border-radius: 4px !important;
        opacity: 0.7 !important;
        transition: all 0.2s ease !important;
      }

      .stroke-delete-btn:hover {
        opacity: 1 !important;
        background-color: #fef2f2 !important;
      }

      /* Force scrollbars to always show when content overflows */
      #strokeVisibilityControls {
        scroll-behavior: smooth;
        overflow-y: scroll !important;
        scrollbar-width: auto !important;
        scrollbar-color: #9ca3af #f3f4f6 !important;
      }

      /* Ensure outer image panel content never scrolls; inner #imageList handles scrolling */
      #imagePanelContent {
        overflow: hidden !important;
        position: relative !important;
        z-index: 100 !important;
      }

      #imageList {
        position: relative;
        z-index: 100;
      }

      #elementsBody {
        position: relative !important;
        z-index: 10200 !important;
        isolation: isolate !important;
      }

      #strokePanel {
        z-index: 10200 !important;
        isolation: isolate !important;
        background: white !important;
      }

      #elementsBody {
        background: white !important;
      }

      #imagePanel {
        z-index: 10200 !important;
        isolation: isolate !important;
      }

      .floating-panel {
        z-index: 10200 !important;
        isolation: isolate !important;
      }

      #topToolbar {
        z-index: 1000 !important;
      }

      #navigation-container {
        background: white !important;
        z-index: 10300 !important;
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
      }

      #mini-stepper {
        background: white !important;
        z-index: 10300 !important;
      }

      #imagePanelContent {
        background: white !important;
      }

      #imageList {
        background: white !important;
      }

      /* Snap guide line should be above image list content */
      .border-t.border-slate-300\/70 {
        z-index: 10250 !important;
      }

      #strokeVisibilityControls {
        position: relative !important;
        z-index: 10200 !important;
        isolation: isolate;
        transform: translateZ(0);
      }

      /* Force GPU acceleration and stacking context isolation for all toggle SVGs */
      .floating-panel svg,
      button svg,
      [id*='toggle'] svg {
        transform: translateZ(0);
        isolation: isolate;
        will-change: transform;
      }

      #strokeVisibilityControls::-webkit-scrollbar {
        width: 8px !important;
        display: block !important;
      }

      #strokeVisibilityControls::-webkit-scrollbar-track {
        background: #f3f4f6 !important;
        border-radius: 4px !important;
      }

      #strokeVisibilityControls::-webkit-scrollbar-thumb {
        background: #9ca3af !important;
        border-radius: 4px !important;
        border: 1px solid #f3f4f6 !important;
      }

      #strokeVisibilityControls::-webkit-scrollbar-thumb:hover {
        background: #6b7280 !important;
      }

      /* Keep focus treatment tidy */
      #brushSize:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
      }

      /* Modern input styling */
      input[type='text'],
      input[type='number'],
      select {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      input[type='text']:focus,
      input[type='number']:focus,
      select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow:
          0 0 0 2px #3b82f6,
          0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      /* Enhanced color picker active state */
      [data-color].active {
        border-color: #1f2937 !important;
        box-shadow:
          0 0 0 3px rgba(255, 255, 255, 1),
          0 0 0 6px #1f2937 !important;
        transform: scale(1.15);
      }

      /* Image Gallery Styling */
      #imageGallery {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
      }

      #imageGallery::-webkit-scrollbar {
        height: 6px;
      }

      #imageGallery::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
      }

      #imageGallery::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      #imageGallery::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Image thumbnail styling */
      .image-thumbnail {
        flex-shrink: 0;
        width: 120px;
        height: 120px;
        border-radius: 12px;
        border: 2px solid transparent;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        scroll-snap-align: center;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        position: relative;
        overflow: hidden;
      }

      .image-thumbnail:hover {
        border-color: #cbd5e1;
        transform: scale(1.05);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
      }

      .image-thumbnail.active {
        border-color: #3b82f6;
        box-shadow:
          0 0 0 2px rgba(59, 130, 246, 0.2),
          0 10px 25px -3px rgba(0, 0, 0, 0.15);
        transform: scale(1.05);
      }

      .image-thumbnail.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
        z-index: 1000;
      }

      .image-thumbnail.drag-over {
        border-color: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5);
        transform: translateY(-1px) scale(1.05);
      }

      /* --- UI Layering System --- */
      body {
        overflow: hidden;
        margin: 0;
        padding: 0;
      }

      #canvas {
        z-index: 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        cursor: crosshair;
        background: #f8f9fa;
        touch-action: none;
      }

      .canvas-container {
        z-index: 10;
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        pointer-events: none;
      }

      .canvas-container canvas {
        pointer-events: auto;
      }

      .canvas-container .upper-canvas {
        z-index: 11;
        pointer-events: auto;
      }

      .canvas-container .lower-canvas {
        z-index: 10;
      }

      #frame-capture {
        z-index: -1 !important; /* Behind everything - placeholder only shows when no images */
        pointer-events: none;
        opacity: 0.3; /* Make placeholder subtle */
      }

      #frame-content {
        pointer-events: auto;
      }

      #navigation-container {
        z-index: 40;
      }

      #topToolbar {
        z-index: 50;
      }

      /* Floating Panels - Force fixed positioning */
      .floating-panel {
        position: fixed !important; /* Fix: Tailwind 'fixed' class not applying */
        z-index: var(--panel-z-index, 60);
      }

      /* Only apply hover transform to main panels, not side panels */
      #projectPanel:hover,
      #toolsPanel:hover,
      #canvasControls:hover {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: translateY(-1px);
      }

      .floating-panel.dragging {
        z-index: 9999 !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: none !important;
        transition: none !important;
      }

      /* Panel toggle icons (Mobile) */
      .panel-toggle-icon {
        z-index: 65;
      }

      /* Overlays & Dialogs */
      #captureOverlay {
        z-index: 50 !important;
        backdrop-filter: none;
      }

      .capture-frame {
        background: transparent;
        border: 2px solid #22c55e !important;
        transition: none !important;
      }

      .capture-frame.locked {
        cursor: default;
      }

      .capture-frame.unlocked {
        cursor: move;
      }

      .capture-frame.dragging {
        transition: none !important;
      }

      .capture-tab-bar {
        position: fixed;
        left: 50%;
        top: 5.5rem;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(15, 23, 42, 0.12);
        border-radius: 999px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.15);
        z-index: 12000;
        pointer-events: auto;
      }

      .capture-master-target-badge {
        position: fixed;
        left: 50%;
        top: 8.4rem;
        transform: translateX(-50%);
        display: none;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.94);
        color: #0f172a;
        font-size: 12px;
        font-weight: 700;
        z-index: 12001;
        pointer-events: none;
      }

      body.master-view-active .capture-master-target-badge {
        display: inline-flex;
      }

      .capture-tab-bar,
      .capture-tab-bar * {
        pointer-events: auto;
      }

      .capture-tab-list {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .capture-tab {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        background: rgba(226, 232, 240, 0.6);
        color: #0f172a;
        font-size: 12px;
        font-weight: 600;
        transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
      }

      .capture-tab:hover {
        background: rgba(226, 232, 240, 0.9);
      }

      .capture-tab.active {
        background: #2563eb;
        color: #ffffff;
        border-color: rgba(37, 99, 235, 0.8);
        box-shadow: 0 8px 16px rgba(37, 99, 235, 0.25);
      }

      .capture-tab.master {
        background: rgba(15, 23, 42, 0.08);
        color: #0f172a;
      }

      .capture-tab.master.active {
        background: #0f172a;
        color: #ffffff;
      }

      .capture-tab-close {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        line-height: 1;
        background: rgba(15, 23, 42, 0.12);
        color: inherit;
      }

      .capture-tab-add {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px dashed rgba(15, 23, 42, 0.2);
        background: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        font-weight: 600;
        color: #0f172a;
      }

      .capture-tab-master-overlay {
        position: absolute;
        inset: 0;
        z-index: 1550;
        display: none;
        pointer-events: none;
      }

      body.master-view-active .capture-tab-master-overlay {
        display: block;
      }

      body.master-view-active #captureFrame {
        border-color: transparent !important;
        box-shadow: none !important;
        background: transparent !important;
        pointer-events: none;
      }

      body.master-view-active #captureFrame .resize-handles,
      body.master-view-active #captureFrame #unlockInstructions {
        opacity: 0;
        pointer-events: none;
      }

      body.master-view-active #captureFrame #captureLockButton {
        opacity: 1;
        pointer-events: auto;
      }

      .capture-tab-frame {
        position: absolute;
        border: 2px solid rgba(34, 197, 94, 0.95);
        background: rgba(34, 197, 94, 0.2);
        border-radius: 10px;
        pointer-events: auto;
        mix-blend-mode: multiply;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #ffffff;
        overflow: visible;
      }

      .capture-tab-frame-label {
        color: #ffffff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.55);
        pointer-events: none;
      }

      .capture-tab-frame-label.selectable {
        pointer-events: auto;
        cursor: pointer;
        background: rgba(71, 85, 105, 0.7);
        border-radius: 999px;
        padding: 2px 7px;
      }

      .capture-tab-frame:hover {
        background: rgba(34, 197, 94, 0.28);
      }

      .capture-tab-frame.active {
        background: rgba(34, 197, 94, 0.08);
        box-shadow: none;
      }

      .capture-tab-frame.draw-target {
        background: transparent !important;
        box-shadow: none;
        mix-blend-mode: normal;
      }

      .master-resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.95);
        background: rgba(15, 23, 42, 0.85);
        opacity: 0;
        transition: opacity 0.15s ease;
        z-index: 2;
      }

      body.capture-unlocked .capture-tab-frame:hover .master-resize-handle,
      body.capture-unlocked .capture-tab-frame .master-resize-handle:hover {
        opacity: 1;
      }

      .master-resize-handle[data-direction='nw'] {
        left: -5px;
        top: -5px;
        cursor: nwse-resize;
      }
      .master-resize-handle[data-direction='n'] {
        left: calc(50% - 5px);
        top: -5px;
        cursor: ns-resize;
      }
      .master-resize-handle[data-direction='ne'] {
        right: -5px;
        top: -5px;
        cursor: nesw-resize;
      }
      .master-resize-handle[data-direction='e'] {
        right: -5px;
        top: calc(50% - 5px);
        cursor: ew-resize;
      }
      .master-resize-handle[data-direction='se'] {
        right: -5px;
        bottom: -5px;
        cursor: nwse-resize;
      }
      .master-resize-handle[data-direction='s'] {
        left: calc(50% - 5px);
        bottom: -5px;
        cursor: ns-resize;
      }
      .master-resize-handle[data-direction='sw'] {
        left: -5px;
        bottom: -5px;
        cursor: nesw-resize;
      }
      .master-resize-handle[data-direction='w'] {
        left: -5px;
        top: calc(50% - 5px);
        cursor: ew-resize;
      }

      .resize-handle {
        position: absolute;
        opacity: 0;
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
      }

      .capture-frame.unlocked:hover .resize-handle,
      .capture-frame.unlocked .resize-handle:hover {
        opacity: 1;
      }

      .resize-handle:hover {
        transform: scale(1.3);
        background: #3b82f6 !important;
        border-color: white !important;
      }

      #measurementDialogOverlay {
        z-index: 100;
      }

      #lockPopup {
        z-index: 110;
      }

      #aiPreviewModal {
        z-index: 120;
      }

      #scaleDropdown {
        z-index: 130;
      }

      /* Visibility States (minimized rule moved up to line ~684) */

      .floating-panel.hidden,
      .hidden {
        display: none !important;
      }

      #darkOverlay {
        transition: none;
      }
    </style>
  </head>

  <body
    class="bg-gray-50 h-screen overflow-hidden"
    style="padding-top: 48px"
    data-heic-worker-url="https://openpaint-heic-converter.sofapaint-api.workers.dev"
  >
    <!-- Top Toolbar -->
    <div id="topToolbar">
      <div class="toolbar-wrap smart-label-scope" id="toolbarWrap">
        <div id="tbLeft" class="group-gap smart-label-scope">
          <!-- Pre-populated toolbar content to prevent flash -->
          <button id="paste" class="tbtn" title="Upload Images" aria-label="Upload Images">
            <span class="label-long">Upload Images</span><span class="label-short">Upload</span>
          </button>
          <button id="clear" class="tbtn">Clear</button>
          <div id="drawingModeWrapper" class="shape-toggle shape-active">
            <button
              id="drawingModeToggle"
              class="tbtn straight-mode"
              title="Drawing Mode"
              aria-label="Drawing Mode"
              aria-pressed="true"
            >
              <span class="label-long">Straight Line</span><span class="label-short">Straight</span>
              <span class="shape-icon" aria-hidden="true">â–¾</span>
            </button>
            <div class="shape-menu" id="drawingModeMenu">
              <button type="button" data-drawing-mode="line">Straight Line</button>
              <button type="button" data-drawing-mode="curve">Curved Line</button>
              <button type="button" data-drawing-mode="privacy">Privacy Erase</button>
              <button type="button" data-drawing-mode="select">Select</button>
            </div>
          </div>
          <div id="textModeWrapper" class="shape-toggle text-mode-toggle">
            <button id="textModeToggle" class="tbtn" title="Text Tool" aria-label="Text Tool">
              <span class="label-long">Text</span><span class="label-short">Text</span>
              <span class="shape-icon" aria-hidden="true">â–¾</span>
            </button>
            <div class="shape-menu" id="textModeMenu">
              <button type="button" data-text-size="small">Small</button>
              <button type="button" data-text-size="medium">Medium</button>
              <button type="button" data-text-size="large">Large</button>
            </div>
          </div>
          <div id="shapeModeWrapper" class="shape-toggle shape-disabled">
            <button
              id="shapeModeToggle"
              class="tbtn"
              title="Shapes"
              aria-label="Shapes"
              aria-pressed="false"
            >
              <span class="label-long">Shapes</span><span class="label-short">Shapes</span>
              <span class="shape-icon" aria-hidden="true">â– </span>
            </button>
            <div class="shape-menu" id="shapeModeMenu">
              <button type="button" data-shape-option="square">â–  Square</button>
              <button type="button" data-shape-option="triangle">â–² Triangle</button>
              <button type="button" data-shape-option="circle">â— Circle</button>
              <button type="button" data-shape-option="star">â˜… Star</button>
              <button type="button" class="shape-fill-toggle" data-shape-fill-toggle="true">
                Fill: Solid
              </button>
            </div>
          </div>

          <div class="color-swatches">
            <button
              class="active tbtn"
              data-color="#3b82f6"
              style="background-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.6)"
              title="Bright Blue"
            ></button>
            <button
              data-color="#22c55e"
              style="background-color: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.6)"
              title="Bright Green"
              class="tbtn"
            ></button>
            <button
              data-color="#ef4444"
              style="background-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6)"
              title="Bright Red"
              class="tbtn"
            ></button>
            <button
              data-color="#f59e0b"
              style="background-color: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.6)"
              title="Bright Yellow"
              class="tbtn"
            ></button>
            <button
              data-color="#a855f7"
              style="background-color: #a855f7; box-shadow: 0 0 10px rgba(168, 85, 247, 0.6)"
              title="Bright Purple"
              class="tbtn"
            ></button>
            <button
              data-color="#1f2937"
              style="background-color: #1f2937"
              title="Dark Gray"
              class="tbtn"
            ></button>
            <button
              data-color="#ffffff"
              style="
                background-color: rgb(255, 255, 255);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                border: 1px solid #ccc;
              "
              title="White"
              class="tbtn"
            ></button>
            <button
              data-color="#10b981"
              style="background-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.6)"
              title="Bright Emerald"
              class="tbtn"
            ></button>
          </div>
          <select
            id="brushSize"
            class="border border-gray-300 rounded text-sm"
            style="height: 34px; margin: 0; cursor: pointer; width: 60px; padding: 2px 4px"
          >
            <option value="2" selected>2px</option>
            <option value="4">4px</option>
            <option value="6">6px</option>
            <option value="8">8px</option>
            <option value="10">10px</option>
            <option value="15">15px</option>
            <option value="20">20px</option>
          </select>
          <button id="arrowStartBtn" class="tbtn icon-btn" title="Start Arrow">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
          </button>
          <button id="arrowEndBtn" class="tbtn icon-btn" title="End Arrow">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
          <button id="dottedBtn" class="tbtn" title="Line Style">
            <svg width="34" height="12" viewBox="0 0 34 12" aria-hidden="true">
              <line
                x1="2"
                y1="6"
                x2="32"
                y2="6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              ></line>
            </svg>
          </button>
          <button id="undoBtn" class="tbtn icon-btn" title="Undo">â†º</button>
          <button id="redoBtn" class="tbtn icon-btn" title="Redo">â†»</button>
        </div>
        <div id="tbCenter" class="group-gap"></div>
        <div id="tbRight" class="group-gap smart-label-scope">
          <input
            type="text"
            id="projectName"
            placeholder="Project Name"
            value="New Sofa"
            class="tinput"
            data-sharkid="__1"
          />
          <button id="loadProject" title="Load Project" class="tbtn" aria-label="Load Project">
            <span class="label-long">Load Project</span><span class="label-short">Load</span>
          </button>
          <button id="removeBgClientTop" class="tbtn" title="Remove background using server">
            Remove BG
          </button>
          <button id="saveProjectTop" class="tbtn" title="Save Project" aria-label="Save Project">
            <span class="label-long">Save Project</span><span class="label-short">Save</span>
          </button>
          <button id="unitToggleBtn" class="tbtn" title="Toggle units">inches</button>
        </div>
      </div>
    </div>


    <!-- Main Layout Container: Flex layout for sidebars + canvas -->
    <div id="main-layout" class="flex" style="height: calc(100vh - 48px); overflow: hidden">
      <!-- Left Sidebar: Elements Panel -->
      <!-- This will be moved here from its current location -->

      <!-- Center: Canvas Container -->
      <div
        id="main-canvas-wrapper"
        class="flex-1 relative bg-white shadow-inner"
        style="overflow: hidden; z-index: 0"
      >
        <div id="fineRotateGrid" aria-hidden="true"></div>
        <canvas
          id="canvas"
          style="
            cursor: crosshair;
            position: absolute;
            left: 0;
            top: 0;
            max-width: none;
            max-height: none;
          "
        ></canvas>
      </div>

      <!-- Right Sidebar: Images Panel -->
      <!-- This will be moved here from its current location -->
    </div>


    <!-- Main Content Container for Frame Capture -->
    <div
      id="frame-capture"
      class="w-full"
      style="
        min-height: 100vh;
        overflow-y: visible;
        position: relative;
        z-index: -1;
        pointer-events: none;
      "
    >
      <!-- Content will be dynamically generated based on images -->
      <div id="frame-content" class="min-h-screen flex items-center justify-center">
        <div class="text-center p-8">
          <h1 class="text-4xl font-bold text-slate-800 mb-4">OpenPaint Frame Capture</h1>
          <p class="text-slate-600">Images will appear here as you add them to your project</p>
        </div>
      </div>
    </div>

    <!-- Minimal Numeric Pill Strip Navigation - Positioned under frame capture -->

    <!-- Bottom Navigation (Mini Stepper) -->
    <div
      id="navigation-container"
      class="fixed bottom-0 left-0 right-0 z-[2001] pointer-events-none flex justify-center pb-2"
    >
      <ol
        id="mini-stepper"
        class="flex gap-3 px-4 py-3 bg-white/90 backdrop-blur-sm border border-slate-200 rounded-full shadow-lg pointer-events-auto overflow-x-auto snap-x snap-mandatory justify-center items-center min-h-[60px]"
        aria-label="Image quick nav"
      >
        <span id="mini-stepper-indicator" aria-hidden="true"></span>
        <!-- Pills will be generated by JavaScript -->
      </ol>
    </div>

    <!-- Project Header Panel -->
    <div
      id="projectPanel"
      class="floating-panel fixed top-4 right-4 z-30 rounded-2xl w-80 transition-all duration-300 hidden"
    >
      <div class="flex items-center justify-between p-4 cursor-move border-b border-gray-200/50">
        <h3 class="text-base font-bold text-slate-800">Project Settings</h3>
        <button
          id="toggleProjectPanel"
          class="text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg p-1.5 transition-all duration-200 transform hover:scale-110"
          title="Minimize/Expand Panel"
        >
          <svg
            class="w-5 h-5 transform transition-transform duration-200"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </button>
      </div>
      <div id="projectPanelContent" class="p-3 transition-all duration-300">
        <div class="flex flex-col gap-3">
          <!-- Project Info -->
          <div class="flex flex-col gap-3">
            <input
              type="text"
              id="projectNamePanel"
              placeholder="Project Name"
              value="New Sofa"
              class="px-3 py-2.5 border border-gray-300 rounded-xl text-sm bg-white w-full focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 shadow-sm"
            />
            <div class="flex items-center gap-3">
              <label for="unitSelector" class="text-sm font-semibold text-slate-700 w-14"
                >Units:</label
              >
              <select
                id="unitSelector"
                class="px-3 py-2.5 border border-gray-300 rounded-xl text-sm bg-white flex-1 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 shadow-sm"
              >
                <option value="inch">inches</option>
                <option value="cm">cm</option>
              </select>
            </div>

            <!-- Hidden inputs for functionality -->
            <div id="measurementInput" class="hidden">
              <div id="inchInputs" class="flex items-center gap-2">
                <input
                  type="number"
                  id="inchWhole"
                  min="0"
                  value="0"
                  class="w-16 px-2 py-1 border border-gray-300 rounded text-sm"
                />
                <select id="inchFraction" class="px-2 py-1 border border-gray-300 rounded text-sm">
                  <option value="0">0</option>
                  <option value="0.125">1/8</option>
                  <option value="0.25">1/4</option>
                  <option value="0.375">3/8</option>
                  <option value="0.5">1/2</option>
                  <option value="0.625">5/8</option>
                  <option value="0.75">3/4</option>
                  <option value="0.875">7/8</option>
                </select>
              </div>
              <div id="cmInputs" class="hidden">
                <input
                  type="number"
                  id="cmValue"
                  min="0"
                  step="0.1"
                  value="0.0"
                  class="w-16 px-2 py-1 border border-gray-300 rounded text-sm"
                />
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="panel-divider pt-3 mt-2 space-y-2">
            <!-- Load Project button -->
            <div class="flex justify-center">
              <button
                id="loadProject"
                title="Load project from ZIP file"
                class="px-4 py-2 bg-white border border-gray-300 text-slate-700 text-xs font-semibold rounded-xl hover:bg-slate-50 transition-all"
              >
                Load Project
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drawing Tools Panel -->
    <div
      id="toolsPanel"
      class="floating-panel fixed top-4 left-4 z-30 rounded-2xl transition-all duration-300 hidden"
    >
      <div class="flex items-center justify-between p-4 cursor-move border-b border-gray-200/50">
        <h3 class="text-base font-bold text-slate-800">Drawing Tools</h3>
        <button
          id="toggleToolsPanel"
          class="text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg p-1.5 transition-all duration-200 transform hover:scale-110"
          title="Minimize/Expand Panel"
        >
          <svg
            class="w-5 h-5 transform transition-transform duration-200"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </button>
      </div>
      <div id="toolsPanelContent" class="p-4 transition-all duration-300 smart-label-scope">
        <div class="flex flex-col gap-4">
          <!-- Primary Tools -->
          <div class="flex items-center gap-3">
            <button
              id="clear"
              class="px-4 py-2.5 bg-danger-500 hover:bg-danger-600 active:bg-danger-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105 active:scale-95"
            >
              Clear
            </button>
            <button
              id="paste-secondary"
              class="px-4 py-2.5 bg-primary-500 hover:bg-primary-600 active:bg-primary-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105 active:scale-95"
              title="Upload Images"
              aria-label="Upload Images"
            >
              <span class="label-long">Upload Images</span><span class="label-short">Upload</span>
            </button>
            <button
              id="save"
              class="px-4 py-2.5 bg-success-500 hover:bg-success-600 active:bg-success-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105 active:scale-95"
            >
              Save Current
            </button>
            <button
              id="copy"
              class="px-4 py-2.5 bg-primary-500 hover:bg-primary-600 active:bg-primary-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105 active:scale-95"
              title="Copy image to clipboard (cropped to frame)"
              aria-label="Copy Image"
            >
              Copy
            </button>
          </div>

          <!-- AI Tools -->
          <div class="flex items-center gap-3">
            <button
              id="generateSofaBasics"
              class="px-4 py-2.5 bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white text-sm font-semibold rounded-xl shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105 active:scale-95"
              title="Generate AI Sofa Dimensions"
              aria-label="Generate AI Sofa Dimensions"
            >
              <span class="label-long">ðŸ¤– Generate Sofa Basics</span
              ><span class="label-short">AI Basics</span>
            </button>
          </div>

          <!-- Color Palette -->
          <div class="flex items-center gap-3">
            <span class="text-sm font-semibold text-slate-700">Color:</span>
            <div class="flex gap-2">
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110 active"
                data-color="#3b82f6"
                style="background-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.6)"
                title="Bright Blue"
              ></button>
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110"
                data-color="#22c55e"
                style="background-color: #22c55e; box-shadow: 0 0 10px rgba(34, 197, 94, 0.6)"
                title="Bright Green"
              ></button>
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110"
                data-color="#ef4444"
                style="background-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6)"
                title="Bright Red"
              ></button>
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110"
                data-color="#f59e0b"
                style="background-color: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.6)"
                title="Bright Yellow"
              ></button>
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110"
                data-color="#a855f7"
                style="background-color: #a855f7; box-shadow: 0 0 10px rgba(168, 85, 247, 0.6)"
                title="Bright Purple"
              ></button>
              <button
                class="w-10 h-10 rounded-full border-2 border-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-110"
                data-color="#1f2937"
                style="background-color: #1f2937"
                title="Dark Gray"
              ></button>
            </div>
            <input type="color" id="colorPicker" value="#3b82f6" class="hidden" />
          </div>

          <!-- Drawing Mode & Controls -->
          <div class="flex items-center gap-4">
          <div id="drawingModeWrapper" class="shape-toggle shape-active">

              <button
                id="drawingModeToggle"
                class="px-4 py-2.5 bg-white border-2 border-success-500 text-success-600 text-sm font-semibold rounded-xl hover:bg-success-50 hover:border-success-600 active:bg-success-100 transition-all duration-200 transform hover:scale-105 active:scale-95 straight-mode shadow-sm"
                title="Drawing Mode"
                aria-label="Drawing Mode"
                aria-pressed="true"
              >
                <span class="label-long">Straight Line</span><span class="label-short">Straight</span>
                <span class="shape-icon" aria-hidden="true">â–¾</span>
              </button>
              <div class="shape-menu" id="drawingModeMenu">
                <button type="button" data-drawing-mode="line">Straight Line</button>
                <button type="button" data-drawing-mode="curve">Curved Line</button>
                <button type="button" data-drawing-mode="privacy">Privacy Erase</button>
                <button type="button" data-drawing-mode="select">Select</button>
              </div>
            </div>
            <div id="textModeWrapper" class="shape-toggle text-mode-toggle">
              <button
                id="textModeToggle"
                class="px-4 py-2.5 bg-white border-2 border-slate-400 text-slate-700 text-sm font-semibold rounded-xl hover:bg-slate-50 hover:border-slate-500 active:bg-slate-100 transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm"
                title="Text Tool"
                aria-label="Text Tool"
              >
                <span class="label-long">Text</span><span class="label-short">Text</span>
                <span class="shape-icon" aria-hidden="true">â–¾</span>
              </button>
              <div class="shape-menu" id="textModeMenu">
                <button type="button" data-text-size="small">Small</button>
                <button type="button" data-text-size="medium">Medium</button>
                <button type="button" data-text-size="large">Large</button>
              </div>
            </div>
            <div id="shapeModeWrapper" class="shape-toggle shape-disabled">
              <button
                id="shapeModeToggle"
                class="px-4 py-2.5 bg-white border-2 border-slate-400 text-slate-700 text-sm font-semibold rounded-xl hover:bg-slate-50 hover:border-slate-500 active:bg-slate-100 transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-sm"
                title="Shapes"
                aria-label="Shapes"
                aria-pressed="false"
              >
                <span class="label-long">Shapes</span><span class="label-short">Shapes</span>
                <span class="shape-icon" aria-hidden="true">â– </span>
              </button>
              <div class="shape-menu" id="shapeModeMenu">
                <button type="button" data-shape-option="square">â–  Square</button>
                <button type="button" data-shape-option="triangle">â–² Triangle</button>
                <button type="button" data-shape-option="circle">â— Circle</button>
                <button type="button" data-shape-option="star">â˜… Star</button>
                <button type="button" class="shape-fill-toggle" data-shape-fill-toggle="true">
                  Fill: Solid
                </button>
              </div>
            </div>

            </div>
          </div>

          <!-- Arrow & Line Style Controls -->
          <div class="flex items-center gap-4">
            <div id="arrowControls" class="flex items-center gap-3">
              <span class="text-sm font-semibold text-slate-700">Arrows:</span>
              <button id="arrowStartBtn" class="tbtn icon-btn" title="Start Arrow">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
              </button>
              <button id="arrowEndBtn" class="tbtn icon-btn" title="End Arrow">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </button>

              <div class="w-px h-6 bg-slate-200 mx-1"></div>

              <div class="flex items-center gap-2" title="Arrow Size">
                <span class="text-xs text-slate-500">Size:</span>
                <input
                  type="range"
                  id="arrowSize"
                  min="5"
                  max="50"
                  value="15"
                  class="w-20 accent-blue-500"
                />
              </div>

              <select
                id="arrowStyle"
                class="text-xs border border-slate-300 rounded px-1 py-1 bg-white text-slate-700 focus:outline-none focus:border-blue-500"
              >
                <option value="triangular">Triangular</option>
                <option value="filled">Filled</option>
                <option value="curved">Curved</option>
              </select>
            </div>
            <div id="dashControls" class="flex items-center gap-3">
              <span class="text-sm font-semibold text-slate-700">Style:</span>
              <select
                id="dashStyleSelect"
                class="px-3 py-2 border border-gray-300 rounded-xl text-sm bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200 shadow-sm"
              >
                <option value="solid">Solid</option>
                <option value="dotted">Dotted</option>
                <option value="small">Small Dash</option>
                <option value="medium">Medium Dash</option>
                <option value="large">Large Dash</option>
                <option value="dot-dash">Dot-Dash</option>
                <option value="custom">Custom</option>
              </select>
              <div id="customDashControls" class="hidden items-center gap-2">
                <input
                  type="number"
                  id="dashLengthInput"
                  min="1"
                  max="50"
                  value="5"
                  class="w-16 px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
                  title="Dash length"
                />
                <span class="text-xs text-slate-500">/</span>
                <input
                  type="number"
                  id="gapLengthInput"
                  min="1"
                  max="50"
                  value="5"
                  class="w-16 px-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
                  title="Gap length"
                />
              </div>
            </div>
          </div>

          <!-- Stroke Counter -->
          <div class="text-sm text-gray-600 font-medium">
            <span id="strokeCounter">Lines: 0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Vectors and Tags Panel (Left Sidebar) -->
    <div
      id="strokePanel"
      class="floating-panel flex-shrink-0 w-64 transition-all duration-300 overflow-hidden bg-white border-r border-gray-200 shadow-xl z-10 flex flex-col"
      style="
        max-height: 100%;
        height: calc(100% - 128px) !important;
        position: fixed !important;
        top: 48px !important;
        left: 0 !important;
      "
    >
      <div
        id="elementsHeader"
        class="flex items-center justify-between p-3 border-b border-gray-200/50 bg-white"
      >
        <div class="flex items-center gap-2">
          <h3 class="text-sm font-semibold text-slate-800">Elements</h3>
          <button
            id="viewMeasurementsToggle"
            title="Toggle measurement labels display"
            class="px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all font-medium"
          >
            Show Labels
          </button>
        </div>
        <button
          id="toggleStrokePanel"
          class="text-slate-500 hover:text-slate-700 rounded-lg p-1 transition-all"
          title="Minimize/Expand Panel"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            style="isolation: isolate; transform: translateZ(0)"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            ></path>
          </svg>
        </button>
      </div>
      <!-- Panel Body (collapsible) -->
      <div
        id="elementsBody"
        role="region"
        aria-labelledby="elementsHeader"
        class="flex-1 flex flex-col min-h-0"
        style="position: relative; z-index: 100"
      >
        <div id="elementsControls" class="px-3 pt-3 pb-1 border-b border-gray-100">
          <div class="flex gap-2 mb-2">
            <button
              id="selectAllStrokesBtn"
              title="Select/Deselect all elements"
              class="flex-1 px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-all font-medium"
            >
              Deselect All
            </button>
            <button
              id="showAllMeasurementsBtn"
              title="Show all measurements in a list"
              class="flex-1 px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-all font-medium"
            >
              Show List
            </button>
            <button
              id="viewSubmittedMeasurementsBtn"
              title="View submitted measurements from shared projects"
              class="flex-1 px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-all font-medium"
            >
              View Submitted
            </button>
          </div>
          <div class="flex gap-2 mb-2">
            <div class="flex-1 px-2 py-1 text-xs bg-gray-50 border border-gray-200 rounded-lg">
              <div class="text-gray-500 text-xs mb-1">Next Tag:</div>
              <div
                id="nextTagDisplay"
                contenteditable="true"
                spellcheck="false"
                class="font-semibold text-blue-600 cursor-text hover:bg-blue-50 px-1 py-0.5 rounded outline-none focus:ring-2 focus:ring-blue-300"
                title="Type to set next tag"
              >
                A
              </div>
            </div>
          </div>
          <div class="flex gap-2 flex-wrap items-center">
            <button
              id="tagModeToggle"
              title="Toggle between letters only and letters with numbers"
              class="px-2 py-1 text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-all font-medium"
            >
              Letters + Numbers
            </button>
            <label
              class="flex items-center gap-1 text-xs bg-slate-50 border border-slate-200 px-2 py-1 rounded-lg"
            >
              <input id="toggleShowMeasurements" type="checkbox" class="accent-blue-600" checked />
              Show measurements
            </label>
            <button
              id="toggleReviewOnly"
              title="Show only measurements under review"
              class="px-2 py-1 text-xs bg-slate-50 border border-slate-200 rounded-lg hover:bg-slate-100 transition-colors"
            >
              Review only
            </button>
            <div
              class="flex items-center gap-1 text-xs bg-slate-50 border border-slate-200 px-2 py-1 rounded-lg"
            >
              <span class="text-slate-600">Tag Size:</span>
              <button
                id="decreaseAllTagSize"
                title="Decrease tag size for all tags on this image"
                class="w-5 h-5 bg-white border border-slate-300 rounded hover:bg-slate-50 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-colors"
              >
                âˆ’
              </button>
              <span id="currentTagSize" class="text-slate-700 font-medium min-w-[2ch] text-center"
                >20</span
              >
              <button
                id="increaseAllTagSize"
                title="Increase tag size for all tags on this image"
                class="w-5 h-5 bg-white border border-slate-300 rounded hover:bg-slate-50 flex items-center justify-center text-slate-600 hover:text-slate-800 transition-colors"
              >
                +
              </button>
            </div>

            <button
              id="unitToggleBtnSecondary"
              class="px-2 py-1 text-xs bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              title="Toggle units"
            >
              inches
            </button>
            <button
              id="labelShapeToggleBtn"
              class="px-2 py-1 text-xs bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              title="Toggle tag shape"
              aria-pressed="true"
            >
              â– 
            </button>
            <button
              id="labelBackgroundToggleBtn"
              class="px-2 py-1 text-xs bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
              title="Toggle label background"
              aria-pressed="false"
            >
              Solid
            </button>
          </div>
        </div>
        <div
          id="strokeVisibilityControls"
          class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col min-h-0"
          style="box-sizing: border-box; position: relative; z-index: 100"
        >
          <div
            id="strokesList"
            class="px-3 pt-2 pb-2 flex-grow flex flex-col justify-center"
            style="padding-bottom: 70px !important"
          ></div>
        </div>
      </div>
    </div>

    <!-- Image Gallery Panel (Right Sidebar) -->
    <div
      id="imagePanel"
      class="floating-panel flex-shrink-0 w-72 transition-all duration-300 overflow-hidden bg-white border-l border-gray-200 flex flex-col shadow-xl z-10"
      style="
        max-height: 100%;
        height: calc(100% - 128px) !important;
        position: fixed !important;
        top: 48px !important;
        right: 0 !important;
      "
    >
      <div
        id="imagePanelHeader"
        class="flex items-center justify-between p-3 border-b border-gray-200/50 bg-white"
      >
        <h3 class="text-sm font-semibold text-slate-800">Images</h3>
        <div class="flex items-center gap-2">
          <label
            class="flex items-center gap-1 text-[11px] font-medium text-slate-600 bg-slate-100 border border-slate-200 rounded-lg px-2 py-1 select-none"
            title="Toggle whether scrolling selects images automatically"
          >
            <input type="checkbox" id="scrollSelectToggle" class="accent-blue-600" checked />
            <span>Scroll selects</span>
            <span
              class="text-[10px] uppercase tracking-wide text-blue-600"
              id="scrollSelectModeLabel"
              >Auto</span
            >
          </label>
          <button
            id="toggleImagePanel"
            class="text-slate-500 hover:text-slate-700 rounded-lg p-1 transition-all"
            title="Minimize/Expand Panel"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
        </div>
      </div>
      <!-- Name/title box outside the scroll area (always visible at top of images panel) -->
      <div class="image-name-container px-3 bg-white border-b border-slate-200 py-2">
        <label for="currentImageNameBox" class="block text-[10px] text-slate-500 mb-1"
          >Image name</label
        >
        <input
          id="currentImageNameBox"
          type="text"
          class="w-full px-2 py-1 border border-slate-300 rounded-md text-[12px] focus:outline-none focus:ring-2 focus:ring-primary-300"
          placeholder="Rename current image"
        />
      </div>
      <div
        id="imagePanelContent"
        class="p-3 transition-all duration-300 flex-1 flex flex-col min-h-0"
        style="position: relative; z-index: 100"
      >
        <!-- Wrapper for list and guide line to ensure perfect centering -->
        <div class="relative flex-1 min-h-0 mb-4 h-full">
          <!-- Legacy image list for backwards compatibility -->
          <div
            id="imageList"
            class="space-y-4 mb-0 h-full overflow-y-auto overflow-x-hidden pr-0 snap-y snap-mandatory scroll-smooth"
            style="
              padding-top: calc(30vh - 5rem);
              padding-bottom: calc(30vh - 5rem + 70px);
              position: relative;
              z-index: 100;
            "
          ></div>

          <!-- Snap guide line -->
          <div
            class="pointer-events-none absolute left-0 right-0 top-1/2 -translate-y-1/2 border-t border-slate-300/70 z-[80]"
          ></div>
        </div>

        <!-- Gallery (disabled in vertical list mode) -->
        <div class="mb-4 hidden">
          <div id="imageGallery" class="hidden"></div>
          <div id="imageDots" class="hidden"></div>
        </div>

        <!-- Image meta removed (name/type inputs no longer used) -->

        <!-- Navigation controls removed -->
      </div>
    </div>

    <!-- Mobile panel toggle icons (outside panels to avoid overflow clipping) -->
    <div
      id="strokePanelIcon"
      class="panel-toggle-icon"
      data-panel="strokePanel"
      style="display: none; opacity: 0"
    >
      âœï¸
    </div>
    <div
      id="imagePanelIcon"
      class="panel-toggle-icon"
      data-panel="imagePanel"
      style="display: none; opacity: 0"
    >
      ðŸ–¼ï¸
    </div>

    <!-- Capture Frame -->
    <div id="captureOverlay" class="fixed inset-0 pointer-events-none" style="z-index: 1500">
      <div id="captureTabMasterOverlay" class="capture-tab-master-overlay"></div>
      <!-- Capture frame -->
      <div
        id="captureFrame"
        class="capture-frame absolute bg-transparent"
        style="
          left: calc(50% - 400px);
          top: calc(50% - 300px);
          width: 800px;
          height: 600px;
          pointer-events: none;
          border: 2px solid #22c55e !important;
        "
      >
        <!-- Lock button -->
        <button
          id="captureLockButton"
          class="absolute -bottom-8 -right-8 w-8 h-8 bg-white border border-gray-300 rounded shadow-md hover:bg-gray-50 transition-colors flex items-center justify-center text-gray-600"
          style="pointer-events: auto"
          title="Lock/Unlock frame (L)"
        >
          <!-- Locked icon -->
          <svg class="locked-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path
              d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
            ></path>
          </svg>
          <!-- Unlocked icon -->
          <svg class="unlocked-icon w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path
              d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z"
            ></path>
          </svg>
        </button>

        <!-- Resize handles (hidden when locked) -->
        <div class="resize-handles">
          <div
            class="resize-handle w-3 h-3 -top-1 -left-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: nw-resize"
            data-direction="nw"
          ></div>
          <div
            class="resize-handle w-3 h-3 -top-1 left-1/2 -translate-x-1/2 bg-white border border-blue-400 rounded-sm"
            style="cursor: n-resize"
            data-direction="n"
          ></div>
          <div
            class="resize-handle w-3 h-3 -top-1 -right-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: ne-resize"
            data-direction="ne"
          ></div>
          <div
            class="resize-handle w-3 h-3 top-1/2 -translate-y-1/2 -right-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: e-resize"
            data-direction="e"
          ></div>
          <div
            class="resize-handle w-3 h-3 -bottom-1 -right-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: se-resize"
            data-direction="se"
          ></div>
          <div
            class="resize-handle w-3 h-3 -bottom-1 left-1/2 -translate-x-1/2 bg-white border border-blue-400 rounded-sm"
            style="cursor: s-resize"
            data-direction="s"
          ></div>
          <div
            class="resize-handle w-3 h-3 -bottom-1 -left-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: sw-resize"
            data-direction="sw"
          ></div>
          <div
            class="resize-handle w-3 h-3 top-1/2 -translate-y-1/2 -left-1 bg-white border border-blue-400 rounded-sm"
            style="cursor: w-resize"
            data-direction="w"
          ></div>
        </div>
      </div>
    </div>
    <div id="captureTabBar" class="capture-tab-bar">
      <div id="captureTabList" class="capture-tab-list"></div>
      <button id="captureTabAdd" class="capture-tab-add" type="button">New Tab</button>
    </div>
    <div id="captureMasterTargetBadge" class="capture-master-target-badge"></div>

    <!-- Instruction Text for Unlocked Mode -->
    <div
      id="unlockInstructions"
      class="fixed top-32 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-80 text-white px-4 py-2 rounded-lg shadow-xl hidden backdrop-blur-sm z-40"
    >
      <div class="text-sm font-medium text-center">
        Press <kbd class="px-1 py-0.5 bg-white bg-opacity-20 rounded text-xs">L</kbd> or click lock
        icon to exit positioning mode
      </div>
    </div>

    <!-- macOS Style Lock Popup -->
    <div
      id="lockPopup"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white px-4 py-2 rounded-lg shadow-xl hidden transition-all duration-200 backdrop-blur-sm"
      style="z-index: 50"
    >
      <div class="flex items-center gap-2">
        <svg id="lockPopupIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
          ></path>
        </svg>
        <span id="lockPopupText">Locked</span>
      </div>
    </div>

    <!-- Canvas Controls (Bottom Panel) -->
    <div
      id="canvasControls"
      class="floating-panel fixed rounded-2xl px-3 py-2 transition-all duration-300"
      style="bottom: 4rem; left: 50%; transform: translateX(-50%); z-index: 10000; display: block"
    >
      <div id="canvasControlsContent" class="flex items-center gap-2 text-sm smart-label-scope">
        <button
          id="copyCanvasBtn"
          class="flex items-center gap-1 px-3 py-1 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs rounded-lg shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-[1.02] active:scale-95"
          title="Copy image to clipboard"
          aria-label="Copy Image"
        >
          <span class="copy-icon-container relative w-3.5 h-3.5">
            <!-- Copy icon (two boxes) -->
            <svg
              id="copyIcon"
              class="w-3.5 h-3.5 opacity-90 transition-all duration-200 absolute inset-0"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                d="M16 1H4a2 2 0 00-2 2v12h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"
              ></path>
            </svg>
            <!-- Checkmark icon (success) -->
            <svg
              id="checkIcon"
              class="w-3.5 h-3.5 opacity-0 scale-50 transition-all duration-200 absolute inset-0"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path>
            </svg>
          </span>
          <span class="label-long">Copy Image</span>
          <span class="label-short">Copy</span>
        </button>
        <select
          id="fitModeSelect"
          class="px-2 py-1 border border-gray-300 rounded-lg bg-white focus:outline-none hover:bg-gray-50"
        >
          <option value="fit-width" selected>Fit Width</option>
          <option value="fit-height">Fit Height</option>
          <option value="fit-canvas">Fit Canvas</option>
          <option value="actual-size">Actual Size</option>
        </select>
        <button
          id="scaleButton"
          class="px-2 py-1 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50"
          aria-haspopup="listbox"
          aria-expanded="false"
          type="button"
        >
          100%
          <svg
            class="inline w-3 h-3 -mt-0.5"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M5.25 7.5l4.5 4.5 4.5-4.5H5.25z" />
          </svg>
        </button>
        <div id="rotateFineWrap" class="rotate-fine-wrap ml-2" data-skip-uniform="true">
          <div class="flex items-center gap-1">
            <button
            id="rotateLeftCtrl"
            class="px-2 py-1 bg-white border border-gray-300 text-slate-700 text-xs rounded-lg hover:bg-slate-50 icon-btn tbtn"
            title="Rotate 90Â° CCW"
          >
            â†¶
          </button>
          <button
            id="rotateRightCtrl"
            class="px-2 py-1 bg-white border border-gray-300 text-slate-700 text-xs rounded-lg hover:bg-slate-50 icon-btn tbtn"
            title="Rotate 90Â° CW"
          >
            â†·
          </button>
          </div>
          <div id="rotateFinePanel" class="rotate-fine-panel">
            <div class="rotate-fine-row">
              <span class="rotate-fine-label">Fine</span>
              <input
                id="rotateFineSlider"
                type="range"
                min="-45"
                max="45"
                step="1"
                value="0"
                aria-label="Fine rotate"
              />
              <span id="rotateFineValue" class="rotate-fine-value">0Â°</span>
            </div>
          </div>
        </div>

        <!-- Share/Update next to Copy/Save -->
        <button
          id="shareProjectBtn"
          class="px-3 py-1 bg-white border border-gray-300 text-slate-700 text-xs rounded-lg shadow-sm hover:shadow-md hover:bg-slate-50 transition-all duration-200 transform hover:scale-[1.02] active:scale-95"
          title="Create shareable URL for customer measurements"
        >
          Share
        </button>

        <!-- Quick Save with hover menu -->
        <div id="quickSave" class="relative ml-2">
          <button
            id="quickSaveBtn"
            class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg"
          >
            Save
          </button>
          <div
            id="quickSaveMenu"
            class="hidden absolute bottom-full mb-1 left-0 bg-white border border-gray-200 rounded-xl shadow-lg min-w-[120px]"
            style="white-space: nowrap; z-index: 5000"
          >
            <button
              class="block w-full text-left px-3 py-2 text-xs hover:bg-slate-50 rounded-t-xl transition-colors"
              data-action="pdf"
            >
              Save as PDF
            </button>
            <button
              class="block w-full text-left px-3 py-2 text-xs hover:bg-slate-50 rounded-b-xl transition-colors"
              data-action="multiple"
            >
              Save Multiple
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status message element for notifications -->
    <div id="statusMessage"></div>

    <!-- Scripts -->
    <!-- Legacy runtime disabled: use Vite src build -->


    <!-- Export utilities with pdf-lib (inline) -->

    <!-- New UI Controller Script -->

    <!-- Scale Dropdown - positioned outside panel hierarchy -->

    <!-- New coordinate system scripts -->

    <!-- Load AI Export Module before paint.js -->

    <!-- Fabric.js -->

    <!-- Extracted UI Modules (MUST load in this order - see EXTRACTION_SUMMARY.md) -->
    <!-- Legacy tag-system module disabled; inline scoped tag logic is authoritative -->

    <!-- New Modules -->

    <!-- TypeScript Bridge (Migration) -->


    <!-- Minimal Numeric Pill Strip Implementation -->

    <!-- AI Preview Modal -->
    <div
      id="aiPreviewModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-auto m-4">
        <h2 class="text-xl font-bold mb-4">AI SVG Preview</h2>
        <div
          id="aiPreviewContainer"
          class="border border-gray-300 rounded mb-4 relative bg-gray-50 min-h-[400px] flex items-center justify-center"
        >
          <!-- SVG overlay will be inserted here -->
          <p class="text-gray-400">Loading preview...</p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button
            id="aiAccept"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          >
            Accept
          </button>
          <button
            id="aiSaveToProject"
            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
          >
            Save to Project
          </button>
          <button
            id="aiDownloadSVG"
            class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
          >
            Download SVG
          </button>
          <button
            id="aiDownloadPNG"
            class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
          >
            Download PNG
          </button>
          <button
            id="aiCancel"
            class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- AI Calibration Dialog -->
    <dialog
      id="ai-calibration-dialog"
      class="backdrop:bg-black backdrop:bg-opacity-50 bg-white rounded-2xl shadow-2xl border-0 p-0 max-w-md w-full"
    >
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-slate-800">AI Calibration</h3>
          <button
            onclick="document.getElementById('ai-calibration-dialog').close()"
            class="text-slate-400 hover:text-slate-600 text-xl"
          >
            &times;
          </button>
        </div>

        <div class="mb-4">
          <p class="text-sm text-slate-600 mb-2">AI detected the overall width as:</p>
          <div class="bg-slate-100 rounded-lg p-3 text-center">
            <span id="detected-width-pixels" class="text-lg font-semibold text-slate-800">0px</span>
          </div>
        </div>

        <form id="calibration-form" onsubmit="handleCalibrationSubmit(event)">
          <div class="mb-4">
            <label for="real-width" class="block text-sm font-semibold text-slate-700 mb-2"
              >Real width:</label
            >
            <input
              type="number"
              id="real-width"
              name="real-width"
              step="0.1"
              min="0.1"
              max="1000"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
              placeholder="Enter real width"
              required
            />
          </div>

          <div class="mb-6">
            <label for="unit" class="block text-sm font-semibold text-slate-700 mb-2">Unit:</label>
            <select
              id="unit"
              name="unit"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
            >
              <option value="cm">Centimeters (cm)</option>
              <option value="mm">Millimeters (mm)</option>
              <option value="in">Inches (in)</option>
            </select>
          </div>

          <div class="flex gap-3">
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg transition-colors"
            >
              Generate
            </button>
              <button
                type="button"
                class="shape-fill-toggle"
                data-shape-fill-toggle="true"
              >
                Fill: Solid
              </button>
            </div>
          </div>

        </form>
      </div>
    </dialog>

    <!-- AI Preview Modal -->
    <dialog
      id="ai-preview-modal"
      class="backdrop:bg-black backdrop:bg-opacity-50 bg-white rounded-2xl shadow-2xl border-0 p-0 max-w-2xl w-full"
    >
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-slate-800">AI Dimension Preview</h3>
          <button
            onclick="document.getElementById('ai-preview-modal').close()"
            class="text-slate-400 hover:text-slate-600 text-xl"
          >
            &times;
          </button>
        </div>

        <div class="mb-4">
          <div id="ai-status-text" class="text-sm text-slate-600 mb-3">Calibrated: 1 cm = 0 px</div>
          <div id="ai-dimension-summary" class="bg-slate-50 rounded-lg p-4 space-y-2">
            <!-- Dimension summary will be populated here -->
          </div>
        </div>

        <div class="flex gap-3">
          <button
            onclick="handlePreviewAction('accept')"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
          >
            Accept
          </button>
          <button
            onclick="handlePreviewAction('save')"
            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
          >
            Save to Project
          </button>
          <button
            onclick="handlePreviewAction('download-svg')"
            class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors"
          >
            Download SVG
          </button>
          <button
            onclick="handlePreviewAction('cancel')"
            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold rounded-lg transition-colors"
          >
            Cancel
          </button>
        </div>
      </div>
    </dialog>

    <!-- Load AI Integration Module -->

    <!-- Single Vite bundle entry point -->
    <script type="module" src="/src/main.ts"></script>

  </body>
</html>
